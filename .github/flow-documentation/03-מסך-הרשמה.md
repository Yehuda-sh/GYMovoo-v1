# 🔐 מסך הרשמה (RegisterScreen)

> **קובץ:** `src/screens/auth/RegisterScreen.tsx`  
> **מטרה:** יצירת חשבון משתמש חדש, העלאת נתוני שאלון לשרת ומעבר לאפליקציה

## 📱 תצוגת המסך

### 🎨 מבנה המסך

- **כותרת** - "יצירת חשבון חדש"
- **תת-כותרת** - "הצטרף למהפכת הכושר שלך"
- **טופס רישום** - שדות קלט עם ולידציה
- **כפתורי פעולה** - הרשמה רגילה וגוגל
- **קישורים** - התחברות, תנאי שימוש

### 📝 שדות הטופס

1. **שם מלא** - שדה טקסט עם ולידציה
2. **כתובת אימייל** - עם בדיקת פורמט
3. **סיסמה** - עם מד חוזק סיסמה
4. **אישור סיסמה** - התאמה לסיסמה
5. **אישור גיל 16+** - תיבת סימון
6. **אישור תנאי שימוש** - תיבת סימון + קישור

## 🔘 כפתורים ופעולות

### 1️⃣ כפתור "צור חשבון"

**טקסט בממשק:** "צור חשבון"  
**שם הפונקציה:** `handleRegister`

#### 🎯 מה קורה בלחיצה:

```javascript
const handleRegister = async () => {
  // 1. ולידציה של הטופס
  if (!validateForm()) {
    showFieldErrors();
    return;
  }

  // 2. בדיקת תנאים
  if (!is16Plus || !acceptTerms) {
    showError("יש לאשר את התנאים");
    return;
  }

  // 3. יצירת אובייקט משתמש
  const newUser = {
    email: email,
    name: fullName,
    id: `user_${Date.now()}`,
    provider: "manual",
    registration: {
      password,
      confirmPassword,
      is16Plus,
      acceptedTerms: acceptTerms,
    },
  };

  // 4. ניסיון יצירה ב-Supabase עם fallback
  try {
    savedUser = await userApi.create(newUser);
  } catch (supabaseError) {
    // במצב פיתוח - fallback ל-localDataService
    if (__DEV__ && process.env.EXPO_PUBLIC_ENABLE_DEV_AUTH === "1") {
      savedUser = localDataService.addUser(newUser);
    } else {
      throw supabaseError;
    }
  }

  // 5. שמירה ב-Zustand Store
  useUserStore.getState().setUser(savedUser);

  // 6. בדיקה האם יש נתוני שאלון ב-AsyncStorage
  const questionnaireData = await AsyncStorage.getItem(
    "smart_questionnaire_results"
  );
  const questionnaireMetadata = await AsyncStorage.getItem(
    "questionnaire_metadata"
  );

  if (questionnaireData && questionnaireMetadata) {
    // יש נתוני שאלון - העלה לשרת ועבור לראשי
    await uploadQuestionnaireAndGoToMain();
  } else {
    // אין נתוני שאלון - עבור לשאלון
    navigation.reset({ index: 0, routes: [{ name: "Questionnaire" }] });
  }
};
```

#### 💾 נתונים נשמרים:

```javascript
// Zustand Store
user: {
  id: "user_1725456789123",
  email: "user@example.com",
  name: "ישראל ישראלי",
  provider: "manual",
  hasQuestionnaire: false // יתעדכן אחרי העלאת שאלון
}

// Supabase
users table: {
  id, email, name, provider, registration_data, created_at
}

// ניקוי AsyncStorage זמני
remove: ["questionnaire_metadata", "smart_questionnaire_results", "questionnaire_draft"]
```

#### ➡️ זרימה לאחר הרשמה:

```javascript
const uploadQuestionnaireAndGoToMain = async () => {
  // פירוק נתוני השאלון
  const metadata = JSON.parse(questionnaireMetadata);
  const results = JSON.parse(questionnaireData);

  // עדכון המשתמש עם נתוני השאלון
  const userWithQuestionnaire = {
    ...savedUser,
    smartquestionnairedata: {
      answers: results.answers || results,
      metadata: {
        ...metadata,
        completedAt: metadata.completedAt || new Date().toISOString(),
        version: "2.0",
      },
    },
    hasQuestionnaire: true,
  };

  // שמירה מעודכנת
  useUserStore.getState().setUser(userWithQuestionnaire);

  // ניקוי נתונים זמניים
  await AsyncStorage.multiRemove([
    "questionnaire_metadata",
    "smart_questionnaire_results",
    "questionnaire_draft",
  ]);

  // מעבר למסך ראשי
  navigation.reset({ index: 0, routes: [{ name: "MainApp" }] });
};
```

### 2️⃣ כפתור "הרשמה עם Google"

**טקסט בממשק:** "הרשמה עם Google"  
**שם הפונקציה:** `handleGoogleRegister`

#### 🎯 פעולה:

```javascript
const handleGoogleRegister = async () => {
  // 1. בדיקת תנאים (גיל ותנאי שימוש)
  if (!is16Plus || !acceptTerms) return;

  // 2. קריאה לשירות Google (דמה בפיתוח)
  const googleUser = await fakeGoogleRegister();

  // 3. יצירה ב-Supabase (עם fallback)
  // 4. אותו הלוגיק של בדיקת נתוני שאלון
  // 5. מעבר לראשי/שאלון בהתאם
};
```

### 3️⃣ קישור "התחבר עכשיו"

**טקסט בממשק:** "כבר יש לך חשבון? התחבר עכשיו"  
**שם הפונקציה:** `() => navigation.navigate("Login")`

#### ➡️ לאן מוביל:

→ **מסך התחברות** (`LoginScreen`)

### 4️⃣ קישור "תנאי שימוש"

**טקסט בממשק:** "תנאי השימוש"  
**שם הפונקציה:** `handleNavigateToTerms`

#### ➡️ לאן מוביל:

→ **מסך תנאי שימוש** (`TermsScreen`)

### 5️⃣ כפתור "מילוי אוטומטי" (פיתוח בלבד)

**מתי מופיע:** רק במצב `__DEV__`  
**מטרה:** מילוי מהיר לבדיקות

## 🛡️ ולידציה ובטיחות

### ✅ בדיקות שדות

```javascript
const validateForm = () => {
  const errors = {};

  // שם מלא
  if (!fullName || fullName.length < 2) {
    errors.fullName = "אנא הזן שם מלא (לפחות 2 תווים)";
  }

  // אימייל
  const emailError = validateEmail(email);
  if (emailError) errors.email = emailError;

  // סיסמה
  if (!password) {
    errors.password = "אנא הזן סיסמה";
  } else if (password.length < 6) {
    errors.password = "הסיסמה חייבת להכיל לפחות 6 תווים";
  }

  // אישור סיסמה
  if (password !== confirmPassword) {
    errors.confirmPassword = "הסיסמאות אינן תואמות";
  }

  setFieldErrors(errors);
  return Object.keys(errors).length === 0;
};
```

### 🔒 מד חוזק סיסמה

```javascript
const computePasswordStrength = (password) => {
  let score = 0;
  if (password.length >= 6) score++;
  if (password.length >= 8) score++;
  if (/[A-Z]/.test(password)) score++;
  if (/[0-9]/.test(password)) score++;
  if (/[^A-Za-z0-9]/.test(password)) score++;

  const levels = [
    { score: 0 - 2, text: "חלשה", color: "#ff4757" },
    { score: 3, text: "בינונית", color: "#ffa502" },
    { score: 4, text: "חזקה", color: "#2ed573" },
    { score: 5, text: "מעולה", color: "#1e90ff" },
  ];

  return levels.find((level) => score <= level.score);
};
```

### 🛡️ אבטחה ואימות

```javascript
// הצפנת סיסמה (מתבצעת בשרת)
const securePassword = await bcrypt.hash(password, 10);

// אימות אימייל
const validateEmail = (email) => {
  const EMAIL_REGEX = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  if (!EMAIL_REGEX.test(email)) {
    return "פורמט אימייל לא תקין";
  }
  return null;
};

// מניעת דוכל רישום
const preventDuplicateSubmission = () => {
  if (loading) return false;
  setLoading(true);
  return true;
};
```

## 💾 שמירת נתונים ובדיקות

### 📱 AsyncStorage - בדיקה ועדכון

```javascript
// בדיקה לנתוני שאלון קיימים
const checkExistingQuestionnaire = async () => {
  const [questionnaireMetadata, smartQuestionnaireResults] = await Promise.all([
    AsyncStorage.getItem("questionnaire_metadata"),
    AsyncStorage.getItem("smart_questionnaire_results"),
  ]);

  return {
    hasData: !!(questionnaireMetadata && smartQuestionnaireResults),
    metadata: questionnaireMetadata ? JSON.parse(questionnaireMetadata) : null,
    results: smartQuestionnaireResults
      ? JSON.parse(smartQuestionnaireResults)
      : null,
  };
};

// ניקוי אחרי העלאה מוצלחת
const cleanupTemporaryData = async () => {
  await AsyncStorage.multiRemove([
    "questionnaire_metadata",
    "smart_questionnaire_results",
    "questionnaire_draft",
    "user_logged_out",
  ]);
};
```

### 🏪 Zustand Store

```javascript
// עדכון מידע משתמש
useUserStore.getState().setUser({
  id: savedUser.id,
  email: savedUser.email,
  name: savedUser.name,
  provider: savedUser.provider,
  hasQuestionnaire: false, // יתעדכן לאחר העלאת השאלון
  smartquestionnairedata: null, // יתעדכן לאחר העלאת השאלון
});

// אחרי העלאת שאלון
useUserStore.getState().setUser({
  ...currentUser,
  hasQuestionnaire: true,
  smartquestionnairedata: questionnaireData,
  trainingstats: {
    selectedEquipment: extractedEquipment,
    fitnessGoals: extractedGoals,
  },
});
```

### ☁️ Supabase

```sql
-- יצירת משתמש חדש
INSERT INTO users (
  id, email, name, provider,
  registration_data, created_at
) VALUES (
  $1, $2, $3, $4, $5, NOW()
);

-- עדכון עם נתוני שאלון (אם קיימים)
UPDATE users SET
  smartquestionnairedata = $1,
  trainingstats = $2,
  hasQuestionnaire = true,
  updated_at = NOW()
WHERE id = $3;
```

## 🔄 זרימת מידע מפורטת

### 📥 נתונים נכנסים

1. **מידע מהמשתמש** - שדות הטופס
2. **נתוני שאלון** - מ-AsyncStorage (אם קיימים)
3. **הגדרות מערכת** - מצב פיתוח, הגדרות Supabase

### 📤 נתונים יוצאים

#### ✅ הרשמה מוצלחת עם נתוני שאלון

```
📍 RegisterScreen
    ↓ (יצירת משתמש + העלאת שאלון)
📊 MainScreen
```

#### ✅ הרשמה מוצלחת ללא נתוני שאלון

```
📍 RegisterScreen
    ↓ (יצירת משתמש)
📋 QuestionnaireScreen
```

#### ❌ כשל ברישום

```
📍 RegisterScreen
    ↓ (הצגת שגיאה)
📍 RegisterScreen (נשאר באותו מסך)
```

## 🎭 אנימציות ומשוב ויזואלי

### ✨ אנימציות

```javascript
// אנימציית כניסה
const fadeInAnimation = () => {
  Animated.timing(fadeAnim, {
    toValue: 1,
    duration: 800,
    useNativeDriver: true,
  }).start();
};

// אנימציית שגיאה (רעידה)
const shakeAnimation = () => {
  Animated.sequence([
    Animated.timing(shakeAnim, { toValue: 10, duration: 50 }),
    Animated.timing(shakeAnim, { toValue: -10, duration: 50 }),
    Animated.timing(shakeAnim, { toValue: 0, duration: 50 }),
  ]).start();
};

// אנימציית הצלחה
const successAnimation = () => {
  Animated.parallel([
    Animated.spring(successScaleAnim, { toValue: 1, useNativeDriver: true }),
    Animated.timing(successRotateAnim, {
      toValue: 1,
      duration: 500,
      useNativeDriver: true,
    }),
  ]).start();
};
```

### 🎨 משוב ויזואלי

- **אינדיקטורי ולידציה** - ✅❌ ליד כל שדה
- **מד חוזק סיסמה** - בר צבעוני מתעדכן
- **ספינר טעינה** - במהלך הרישום
- **הודעות שגיאה** - בטקסט ברור מתחת לשדות

## ⚠️ מצבי שגיאה וטיפול

### 🔴 שגיאת ולידציה

```javascript
const handleValidationError = (errors) => {
  setFieldErrors(errors);
  shakeAnimation.start();

  // התמקדות בשדה הראשון עם שגיאה
  const firstErrorField = Object.keys(errors)[0];
  if (firstErrorField === "email") {
    emailRef.current?.focus();
  }
};
```

### 🔴 כשל ברישום ב-Supabase

```javascript
const handleSupabaseFailure = async (error) => {
  console.warn("⚠️ Supabase creation failed:", error);

  // במצב פיתוח - נסה localDataService
  if (__DEV__ && process.env.EXPO_PUBLIC_ENABLE_DEV_AUTH === "1") {
    try {
      savedUser = localDataService.addUser(newUser);
      console.warn("✅ Fallback: User saved to localDataService");
      return savedUser;
    } catch (localError) {
      throw new Error("כשל ביצירת המשתמש ובגיבוי המקומי");
    }
  } else {
    throw new Error("אירעה שגיאה בהרשמה. אנא נסה שוב.");
  }
};
```

### 🔴 בעיית רשת

```javascript
const handleNetworkError = () => {
  showModal({
    title: "בעיית חיבור",
    message: "אנא בדוק את החיבור לאינטרנט ונסה שוב.",
    confirmText: "נסה שוב",
    onConfirm: () => handleRegister(),
  });
};
```

## 🎨 מפת זרימה חזותית

```
🔐 מסך הרשמה
        │
        ▼
📝 מילוי טופס
        │
        ▼
✅ ולידציה עברה?
   ├── לא ──── ❌ הצגת שגיאות
   └── כן
        │
        ▼
👤 יצירת משתמש ב-Supabase
   ├── הצלחה ────┐
   └── כשל      │
        │        │
        ▼        │
💾 fallback     │
   ├── הצלחה ────┘
   └── כשל ──── ❌ הודעת שגיאה

📦 בדיקת נתוני שאלון ב-AsyncStorage
   ├── קיימים ──── העלאה לשרת ──── 📊 מסך ראשי
   └── לא קיימים ──── 📋 מסך השאלון
```

---

_עודכן: 4 בספטמבר 2025_
