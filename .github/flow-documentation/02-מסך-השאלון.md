# 📋 מסך השאלון (UnifiedQuestionnaireScreen)

> **קובץ:** `src/screens/questionnaire/UnifiedQuestionnaireScreen.tsx`  
> **מטרה:** איסוף העדפות כושר, מטרות ונתונים אישיים לבניית תוכנית אימון מותאמת

## 📱 תצוגת המסך

### 🎨 מבנה המסך

- **כותרת** - "בואו נכיר אותך"
- **בר התקדמות** - מציג אחוז השלמה
- **שאלה נוכחית** - טקסט השאלה וכפתורי בחירה
- **ניווט** - כפתורי "הקודם", "הבא", "סיום"
- **רקע** - גרדיאנט דינמי

### 📝 סוגי שאלות

1. **בחירה יחידה** - רמת כושר, גיל, מטרות
2. **בחירה מרובה** - ציוד זמין, ימי אימון מועדפים
3. **סליידר** - זמן זמין לאימון, תדירות רצויה

## 🔘 כפתורים ופעולות

### 1️⃣ כפתור "הבא"

**טקסט בממשק:** "הבא"  
**שם הפונקציה:** `handleNext`

#### 🎯 מה קורה בלחיצה:

```javascript
const handleNext = () => {
  // 1. ולידציה של התשובה הנוכחית
  if (!validateCurrentAnswer()) {
    showError("אנא בחר תשובה");
    return;
  }

  // 2. שמירת התשובה
  manager.saveAnswer(currentQuestion.id, selectedOptions);

  // 3. מעבר לשאלה הבאה
  const nextQuestion = manager.getNextQuestion();
  if (nextQuestion) {
    setCurrentQuestion(nextQuestion);
    setSelectedOptions([]);
  } else {
    // סיום השאלון
    handleQuestionnaireComplete();
  }

  // 4. שמירה זמנית ב-AsyncStorage
  saveProgressToStorage();
};
```

### 2️⃣ כפתור "הקודם"

**טקסט בממשק:** "הקודם"  
**שם הפונקציה:** `handlePrevious`

#### 🎯 פעולה:

- חזרה לשאלה קודמת
- טעינת תשובה שמורה
- עדכון בר התקדמות

### 3️⃣ כפתור "בואו נתחיל!" (בסיום)

**טקסט בממשק:** "בואו נתחיל!"  
**שם הפונקציה:** `handleQuestionnaireComplete`

#### 🎯 מה קורה בלחיצה:

```javascript
const handleQuestionnaireComplete = async () => {
  // 1. יצירת נתוני שאלון מלאים
  const questionnaireData = manager.generateCompletionData();

  // 2. שמירה ב-AsyncStorage לגיבוי
  await AsyncStorage.setItem(
    "smart_questionnaire_results",
    JSON.stringify(questionnaireData)
  );
  await AsyncStorage.setItem(
    "questionnaire_metadata",
    JSON.stringify({
      completedAt: new Date().toISOString(),
      source: "UnifiedQuestionnaireScreen",
    })
  );

  // 3. בדיקה האם יש משתמש מחובר
  if (user?.id) {
    // יש משתמש - שמור בשרת ועבור לראשי
    await saveToServer(questionnaireData);
    navigation.reset({ index: 0, routes: [{ name: "MainApp" }] });
  } else {
    // אין משתמש - עבור להרשמה
    navigation.navigate("Register");
  }
};
```

### 4️⃣ כפתור "דלג" (אופציונלי)

**טקסט בממשק:** "דלג"  
**מתי מופיע:** שאלות לא חובה

## 💾 שמירת נתונים

### 📱 AsyncStorage

```javascript
// שמירה זמנית של תשובות במהלך המילוי
"questionnaire_draft" = {
  answers: [
    { questionId: "age", value: "25_35" },
    { questionId: "goals", value: ["strength", "weight_loss"] },
    { questionId: "equipment", value: ["dumbbells", "bodyweight"] }
  ],
  progress: 65,
  lastSaved: "2025-09-04T10:30:00Z"
}

// שמירה סופית בסיום השאלון
"smart_questionnaire_results" = {
  answers: { /* כל התשובות */ },
  summary: { /* סיכום */ },
  recommendations: { /* המלצות */ }
}

"questionnaire_metadata" = {
  completedAt: "2025-09-04T10:45:00Z",
  source: "UnifiedQuestionnaireScreen",
  version: "2.0"
}
```

### 🏪 Zustand Store

```javascript
// עדכון מיידי במהלך השאלון
useUserStore.getState().setSmartQuestionnaireData({
  answers: currentAnswers,
  metadata: {
    completedAt: timestamp,
    version: "2.0",
  },
});
```

### ☁️ Supabase (אם יש משתמש)

```sql
UPDATE users SET
  smartquestionnairedata = $1,
  hasQuestionnaire = true,
  trainingstats = $2
WHERE id = $3
```

## 🔄 זרימת מידע מפורטת

### 📥 נתונים נכנסים

1. **בדיקה ראשונית** - האם המשתמש כבר יש לו שאלון?

```javascript
useEffect(() => {
  if (user?.id && user?.hasQuestionnaire && user?.smartquestionnairedata) {
    // עבור ישר לראשי - אין צורך בשאלון
    navigation.reset({ index: 0, routes: [{ name: "MainApp" }] });
  }
}, [user]);
```

2. **שחזור טיוטה** - האם יש שמירה זמנית?

```javascript
const loadSavedProgress = async () => {
  const saved = await AsyncStorage.getItem("questionnaire_draft");
  if (saved) {
    const data = JSON.parse(saved);
    manager.restoreProgress(data);
    // המשך מהנקודה שנשמרה
  }
};
```

### 📤 נתונים יוצאים

1. **למשתמש מחובר** → שמירה ישירה בשרת + מעבר לראשי
2. **למשתמש לא מחובר** → שמירה ב-AsyncStorage + מעבר להרשמה

### 🧮 עיבוד הנתונים

```javascript
// מיפוי תשובות לפורמט מובנה
const processAnswers = () => {
  return {
    personalInfo: {
      age: answers.age,
      gender: answers.gender,
      fitnessLevel: answers.fitness_level,
    },
    goals: answers.goals, // מערך מטרות
    equipment: answers.equipment, // ציוד זמין
    schedule: {
      daysPerWeek: answers.frequency,
      timePerSession: answers.duration,
      preferredDays: answers.days,
    },
    preferences: {
      workoutTypes: answers.workout_types,
      intensity: answers.intensity_preference,
    },
  };
};
```

## 🎯 לוגיקת השאלון

### 📊 סוגי שאלות ותשובות

```javascript
const QUESTIONS = [
  {
    id: "age",
    text: "באיזה קבוצת גיל אתה נמצא?",
    type: "single_choice",
    required: true,
    options: [
      { id: "under_18", text: "מתחת ל-18" },
      { id: "18_25", text: "18-25" },
      { id: "25_35", text: "25-35" },
      { id: "35_50", text: "35-50" },
      { id: "over_50", text: "מעל 50" },
    ],
  },
  {
    id: "goals",
    text: "מהן המטרות שלך? (ניתן לבחור מספר)",
    type: "multiple_choice",
    required: true,
    options: [
      { id: "weight_loss", text: "ירידה במשקל" },
      { id: "muscle_gain", text: "בניית שריר" },
      { id: "strength", text: "חיזוק כללי" },
      { id: "endurance", text: "שיפור כושר גופני" },
      { id: "flexibility", text: "גמישות ומתיחות" },
    ],
  },
  // ... עוד שאלות
];
```

### 🔀 לוגיקה מותנית

```javascript
// שאלות דינמיות לפי תשובות קודמות
const getNextQuestion = (currentAnswers) => {
  if (currentAnswers.goals.includes("weight_loss")) {
    // הראה שאלות על תזונה
    return questions.nutrition;
  }

  if (currentAnswers.equipment.includes("none")) {
    // התמקד באימוני משקל גוף
    return questions.bodyweight_focus;
  }

  return questions.standard_next;
};
```

## 📊 אנליטיקה ומדידות

### 📈 אירועים נמדדים

```javascript
// התחלת השאלון
analytics.track("questionnaire_started");

// תקדמות
analytics.track("questionnaire_progress", {
  questionNumber: currentIndex,
  totalQuestions: totalCount,
  progressPercent: (currentIndex / totalCount) * 100,
});

// השלמת השאלון
analytics.track("questionnaire_completed", {
  timeSpent: completionTime,
  questionsAnswered: answeredCount,
  hasUser: !!user?.id,
});

// נשירה מהשאלון
analytics.track("questionnaire_abandoned", {
  lastQuestion: currentQuestion.id,
  progressPercent: currentProgress,
});
```

## ⚠️ מצבי שגיאה וטיפול

### 🔴 שגיאת שמירה

```javascript
const handleSaveError = async (error) => {
  console.error("Failed to save questionnaire:", error);

  // נסה שמירה מקומית כגיבוי
  try {
    await AsyncStorage.setItem("questionnaire_backup", JSON.stringify(data));
    showModal({
      title: "שמירה זמנית",
      message: "הנתונים נשמרו מקומית. נמשיך כשיחזור החיבור.",
    });
  } catch (backupError) {
    showModal({
      title: "שגיאה",
      message: "אנא ודא שיש מקום פנוי במכשיר ונסה שוב.",
    });
  }
};
```

### 🔴 תשובה חסרה

```javascript
const validateCurrentAnswer = () => {
  if (currentQuestion.required && selectedOptions.length === 0) {
    showError("שאלה זו היא חובה");
    return false;
  }
  return true;
};
```

### 🔴 בעיית ניווט

```javascript
const handleNavigationError = (error) => {
  console.error("Navigation failed:", error);

  // נסה שמירה חירום
  saveEmergencyBackup();

  showModal({
    title: "שגיאה",
    message: "אירעה שגיאה. הנתונים נשמרו ותוכל להמשיך מאוחר יותר.",
    confirmText: "אישור",
    singleButton: true,
  });
};
```

## 🎨 מפת זרימה חזותית

```
📋 כניסה לשאלון
        │
        ▼
🔍 יש משתמש + שאלון?
   ├── כן ────────────────┐
   └── לא                │
        │                ▼
        ▼          📊 מסך ראשי
💾 טעינת טיוטה?
   ├── כן ──── המשך מנקודת עצירה
   └── לא ──── התחלה מחדש
        │
        ▼
❓ מילוי שאלות (לולאה)
        │
        ▼
✅ סיום השאלון
        │
        ▼
👤 יש משתמש מחובר?
   ├── כן ──── שמירה בשרת ──► 📊 מסך ראשי
   └── לא ──── שמירה מקומית ──► 🔐 מסך הרשמה
```

---

_עודכן: 4 בספטמבר 2025_
