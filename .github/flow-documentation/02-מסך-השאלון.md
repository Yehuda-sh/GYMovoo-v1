# 📋 מסך השאלון (UnifiedQuestionnaireScreen)

> **קובץ:** `src/screens/questionnaire/UnifiedQuestionnaireScreen.tsx`  
> **מטרה:** איסוף העדפות כושר, מטרות ונתונים אישיים לבניית תוכנית אימון מותאמת

## 📱 תצוגת המסך

### 🎨 מבנה המסך

- **כותרת** - "בואו נכיר אותך"
- **בר התקדמות** - מציג אחוז השלמה
- **שאלה נוכחית** - טקסט השאלה וכפתורי בחירה
- **ניווט** - כפתורי "הקודם", "הבא", "סיום"
- **רקע** - גרדיאנט דינמי

### 📝 סוגי שאלות

1. **בחירה יחידה** - רמת כושר, גיל, מטרות
2. **בחירה מרובה** - ציוד זמין, ימי אימון מועדפים
3. **סליידר** - זמן זמין לאימון, תדירות רצויה

## 🔘 כפתורים ופעולות

### 1️⃣ כפתור "הבא"

**טקסט בממשק:** "הבא"  
**שם הפונקציה:** `handleNext`

#### 🎯 מה קורה בלחיצה:

```javascript
const handleNext = () => {
  // 1. ולידציה של התשובה הנוכחית
  if (!validateCurrentAnswer()) {
    showError("אנא בחר תשובה");
    return;
  }

  // 2. שמירת התשובה
  manager.saveAnswer(currentQuestion.id, selectedOptions);

  // 3. מעבר לשאלה הבאה
  const nextQuestion = manager.getNextQuestion();
  if (nextQuestion) {
    setCurrentQuestion(nextQuestion);
    setSelectedOptions([]);
  } else {
    // סיום השאלון
    handleQuestionnaireComplete();
  }

  // 4. שמירה זמנית ב-AsyncStorage
  saveProgressToStorage();
};
```

### 2️⃣ כפתור "הקודם"

**טקסט בממשק:** "הקודם"  
**שם הפונקציה:** `handlePrevious`

#### 🎯 פעולה:

- חזרה לשאלה קודמת
- טעינת תשובה שמורה
- עדכון בר התקדמות

### 3️⃣ כפתור "סיים שאלון" (בסיום)

**טקסט בממשק:** "סיים שאלון" (בשאלה האחרונה)  
**שם הפונקציה:** `handleQuestionnaireComplete`

#### 🎯 מה קורה בלחיצה:

```javascript
const handleQuestionnaireComplete = async () => {
  // 1. יצירת נתוני שאלון מלאים
  const questionnaireData = manager.generateCompletionData();

  // 2. שמירה חובה ב-AsyncStorage לפני הרשמה
  try {
    const smartData = manager.toSmartQuestionnaireData();
    await AsyncStorage.setItem(
      "smart_questionnaire_results",
      JSON.stringify(smartData)
    );
  } catch (e) {
    // שמירה נכשלת - חוסמים מעבר להרשמה
    console.error("Failed persisting smart_questionnaire_results", e);
    showModal({
      title: "שגיאת שמירה",
      message: "לא ניתן להמשיך ללא שמירת התשובות. אנא פנה מקום ונסה שוב.",
    });
    return; // חוסמים המשך
  }

  // 3. מעבר להרשמה (המצב היחיד)
  navigation.reset({ index: 0, routes: [{ name: "Register" }] });
};
```

### 4️⃣ כפתור "דלג" (אופציונלי)

**טקסט בממשק:** "דלג"  
**מתי מופיע:** שאלות לא חובה

## 💾 שמירת נתונים

### 📱 AsyncStorage

```javascript
// שמירה זמנית של תשובות במהלך המילוי
"questionnaire_draft" = {
  answers: [
    { questionId: "age", value: "25_35" },
    { questionId: "goals", value: ["strength", "weight_loss"] },
    { questionId: "equipment", value: ["dumbbells", "bodyweight"] }
  ],
  progress: 65,
  lastSaved: "2025-09-04T10:30:00Z"
}

// שמירה סופית בסיום השאלון
"smart_questionnaire_results" = {
  answers: { /* כל התשובות */ },
  summary: { /* סיכום */ },
  recommendations: { /* המלצות */ }
}

"questionnaire_metadata" = {
  completedAt: "2025-09-04T10:45:00Z",
  source: "UnifiedQuestionnaireScreen",
  version: "2.0"
}
```

### 🏪 Zustand Store

```javascript
// עדכון מיידי במהלך השאלון
useUserStore.getState().setSmartQuestionnaireData({
  answers: currentAnswers,
  metadata: {
    completedAt: timestamp,
    version: "2.0",
  },
});
```

### ☁️ Supabase (אם יש משתמש)

```sql
UPDATE users SET
  smartquestionnairedata = $1,
  hasQuestionnaire = true,
  trainingstats = $2
WHERE id = $3
```

## 🔄 זרימת מידע מפורטת

### 📥 נתונים נכנסים

1. **בדיקה ראשונית (Guard)** - משתמש רשום עם שאלון מלא לא יכול להגיע למסך

```javascript
useEffect(() => {
  if (user?.id && user?.hasQuestionnaire && user?.smartquestionnairedata) {
    // Guard: עבור ישר לראשי - אין אפשרות לערוך שאלון
    navigation.reset({ index: 0, routes: [{ name: "MainApp" }] });
  }
}, [user]);
```

**הערה חשובה:** משתמשים רשומים לא יכולים לערוך שאלון. השאלון הוא רק לפני הרשמה.

2. **שחזור טיוטה** - האם יש שמירה זמנית?

```javascript
const loadSavedProgress = async () => {
  const saved = await AsyncStorage.getItem("questionnaire_draft");
  if (saved) {
    const data = JSON.parse(saved);
    // האם להמשיך מהטיוטה או להתחיל מחדש?
    showModal({
      title: "שאלון בתהליך",
      message: "נמצא שאלון שהתחלת. רוצה להמשיך או להתחיל מחדש?",
      confirmText: "המשך",
      cancelText: "התחל מחדש",
      onConfirm: () => manager.restoreProgress(data),
      onCancel: () => startFreshQuestionnaire(),
    });
  }
};
```

### 📤 נתונים יוצאים

**זרימה יחידה:** כל משתמש שמסיים שאלון **חייב** לעבור להרשמה.

1. **למשתמש לא מחובר (המצב היחיד)** → שמירה **חובה** ב-AsyncStorage + reset להרשמה

**עיקרון חשוב:**

- אין משתמש רשום ללא שאלון מלא
- השאלון הוא תמיד לפני ההרשמה
- אחרי הרשמה אי אפשר לחזור לשאלון
- שמירת AsyncStorage חובה - אם נכשלת, חוסמים מעבר להרשמה

**שינוי חשוב:** כל סיום שאלון משתמש ב-`navigation.reset` למניעת חזרה.

### 🧮 עיבוד הנתונים

```javascript
// מיפוי תשובות לפורמט מובנה
const processAnswers = () => {
  return {
    personalInfo: {
      age: answers.age,
      gender: answers.gender,
      fitnessLevel: answers.fitness_level,
    },
    goals: answers.goals, // מערך מטרות
    equipment: answers.equipment, // ציוד זמין
    schedule: {
      daysPerWeek: answers.frequency,
      timePerSession: answers.duration,
      preferredDays: answers.days,
    },
    preferences: {
      workoutTypes: answers.workout_types,
      intensity: answers.intensity_preference,
    },
  };
};
```

## 🎯 לוגיקת השאלון

### 📊 סוגי שאלות ותשובות

```javascript
const QUESTIONS = [
  {
    id: "age",
    text: "באיזה קבוצת גיל אתה נמצא?",
    type: "single_choice",
    required: true,
    options: [
      { id: "under_18", text: "מתחת ל-18" },
      { id: "18_25", text: "18-25" },
      { id: "25_35", text: "25-35" },
      { id: "35_50", text: "35-50" },
      { id: "over_50", text: "מעל 50" },
    ],
  },
  {
    id: "goals",
    text: "מהן המטרות שלך? (ניתן לבחור מספר)",
    type: "multiple_choice",
    required: true,
    options: [
      { id: "weight_loss", text: "ירידה במשקל" },
      { id: "muscle_gain", text: "בניית שריר" },
      { id: "strength", text: "חיזוק כללי" },
      { id: "endurance", text: "שיפור כושר גופני" },
      { id: "flexibility", text: "גמישות ומתיחות" },
    ],
  },
  // ... עוד שאלות
];
```

### 🔀 לוגיקה מותנית

```javascript
// שאלות דינמיות לפי תשובות קודמות
const getNextQuestion = (currentAnswers) => {
  if (currentAnswers.goals.includes("weight_loss")) {
    // הראה שאלות על תזונה
    return questions.nutrition;
  }

  if (currentAnswers.equipment.includes("none")) {
    // התמקד באימוני משקל גוף
    return questions.bodyweight_focus;
  }

  return questions.standard_next;
};
```

## 📊 אנליטיקה ומדידות

### 📈 אירועים נמדדים

```javascript
// התחלת השאלון
analytics.track("questionnaire_started");

// תקדמות
analytics.track("questionnaire_progress", {
  questionNumber: currentIndex,
  totalQuestions: totalCount,
  progressPercent: (currentIndex / totalCount) * 100,
});

// השלמת השאלון
analytics.track("questionnaire_completed", {
  timeSpent: completionTime,
  questionsAnswered: answeredCount,
  hasUser: !!user?.id,
});

// נשירה מהשאלון
analytics.track("questionnaire_abandoned", {
  lastQuestion: currentQuestion.id,
  progressPercent: currentProgress,
});
```

## ⚠️ מצבי שגיאה וטיפול

### 🔴 שגיאת שמירה

```javascript
const handleSaveError = async (error) => {
  console.error("Failed to save questionnaire:", error);

  // נסה שמירה מקומית כגיבוי
  try {
    await AsyncStorage.setItem("questionnaire_backup", JSON.stringify(data));
    showModal({
      title: "שמירה זמנית",
      message: "הנתונים נשמרו מקומית. נמשיך כשיחזור החיבור.",
    });
  } catch (backupError) {
    showModal({
      title: "שגיאה",
      message: "אנא ודא שיש מקום פנוי במכשיר ונסה שוב.",
    });
  }
};
```

### 🔴 תשובה חסרה

```javascript
const validateCurrentAnswer = () => {
  if (currentQuestion.required && selectedOptions.length === 0) {
    showError("שאלה זו היא חובה");
    return false;
  }
  return true;
};
```

### 🔴 בעיית ניווט

```javascript
const handleNavigationError = (error) => {
  console.error("Navigation failed:", error);

  // נסה שמירה חירום
  saveEmergencyBackup();

  showModal({
    title: "שגיאה",
    message: "אירעה שגיאה. הנתונים נשמרו ותוכל להמשיך מאוחר יותר.",
    confirmText: "אישור",
    singleButton: true,
  });
};
```

## 🎨 מפת זרימה חזותית

```
📋 כניסה לשאלון (רק משתמשים לא רשומים)
        │
        ▼
💾 טעינת טיוטה?
   ├── כן ──── שאלה: המשך או התחל מחדש?
   └── לא ──── התחלה מחדש
        │
        ▼
❓ מילוי שאלות (לולאה)
        │
        ▼
✅ סיום השאלון (כפתור "סיים שאלון")
        │
        ▼
� שמירה חובה ב-AsyncStorage
   ├── הצליחה ──── reset להרשמה ──► � מסך הרשמה
   └── נכשלה ──── הודעת שגיאה + חסימת המשך
```

**זרימה מעודכנת (04/09/2025):**

- רק משתמשים לא רשומים יכולים להגיע לשאלון
- שמירת AsyncStorage חובה - נכשלה = חסימה
- כל סיום עובר דרך הרשמה (אין מעבר ישיר לראשי)
- navigation.reset למניעת חזרה
- כפתור בשאלה האחרונה: "סיים שאלון"

---

_עודכן: 4 בספטמבר 2025 - זרימה קשיחה: שאלון → הרשמה בלבד. משתמשים רשומים לא יכולים לערוך שאלון._

---

## 🔒 אינבריינטים (אסור לשבור)

1. אין מצב של משתמש רשום (עם `id`) ללא שאלון מלא / `smartquestionnairedata` תקין.
2. סיום שאלון תמיד מבוצע לפני הרשמה – אין דילוג.
3. `navigation.reset` חובה במעבר להרשמה למניעת חזרה אחורה.
4. הפונקציות הקריטיות שלא נוגעים בהן בלי תיאום:
   - `getCompletionStatus` (ב-`userStore.ts`) מחזירה `isFullySetup = hasSmartQuestionnaire && hasBasicInfo`.
   - `setSmartQuestionnaireData` לא יוצרת משתמש חדש אם אין `user?.email` – רק שומרת ל-AsyncStorage.
5. כישלון שמירת `smart_questionnaire_results` ⇒ חסימת מעבר להרשמה.
6. אין עריכת שאלון לאחר יצירת משתמש (אפילו אם חסר sync לשרת).

## 🧱 מבני נתונים (Contracts)

### SmartQuestionnaireData (נשמר ב-AsyncStorage וב-Store)

```ts
interface SmartQuestionnaireData {
  answers: Record<string, string | string[]>; // ערך אחד או מערך (לשאלות מרובות)
  metadata?: {
    completedAt?: string; // ISO
    version?: string; // גרסה לוגית
    source?: string; // לדוגמה: "UnifiedQuestionnaireScreen"
  };
}
```

### TrainingStats (שדות שרלוונטיים לעדכון אוטומטי מהשאלון)

```ts
interface TrainingStatsSubset {
  preferredWorkoutDays: string[]; // ['monday','wednesday',...]
  selectedEquipment: string[]; // נורמליזציה דרך normalizeEquipment
  fitnessGoals: string[]; // מטרות
  currentFitnessLevel?: string; // רמת כושר
}
```

## 📦 מפתחות אחסון (Storage Keys)

| Key                           | שימוש                          | מתי נכתב                  |
| ----------------------------- | ------------------------------ | ------------------------- |
| `questionnaire_draft`         | טיוטה תוך כדי מילוי            | בכל מעבר שאלה (debounced) |
| `smart_questionnaire_results` | תוצאה מלאה לפני הרשמה          | בסיום לפני reset          |
| `questionnaire_metadata`      | מטא נתונים (תאריך, מקור, גרסה) | בסיום                     |
| `user_gender_preference`      | שדה מגדר לשימוש משני           | אם נבחר מגדר              |
| `selected_equipment`          | ציוד מנורמל                    | אם יש תשובה רלוונטית      |

## 🔍 מדיניות לוגים (Minimal Logging)

נשארים רק אירועים קריטיים:
| קטגוריה | אירוע | רמת לוג |
|---------|-------|---------|
| Persist | `smart_questionnaire_results נשמר` | info |
| Completion | `Questionnaire completed - redirecting to Register` | info |
| Fallback | `No user found, saving questionnaire data to AsyncStorage only` | info |
| Error | כשל בשמירת תוצאה | error |

לוגים מפורטים (progress, לחיצות) – מנוטרלים ברירת מחדל (`DEBUG_LOGS=false`).

## 🧪 צ'ק ליסט לפני Merge

- [ ] סיום שאלון מעביר תמיד ל-Register ולא ל-Main.
- [ ] כישלון יזום ב-AsyncStorage (סימולציה) חוסם מעבר.
- [ ] `getCompletionStatus()` למשתמש חדש ללא ID מחזיר: `{ hasSmartQuestionnaire: true, hasBasicInfo: false, isFullySetup: false }`.
- [ ] לאחר הרשמה: אותו סט נתונים ⇒ `isFullySetup: true`.
- [ ] אין שימוש ב-`setSmartQuestionnaireData` ליצירת user.
- [ ] שמירת ציוד מנורמל (ללא כפילויות, אותיות קטנות).
- [ ] בדיקת RTL – כל הטקסטים מוצגים מימין לשמאל.

## 🧷 Edge Cases & Recovery

| מצב                           | סימפטום                      | פתרון                              |
| ----------------------------- | ---------------------------- | ---------------------------------- |
| כשל שמירת תוצאה סופית         | מודאל "שגיאת שמירה"          | נשאר במסך עד הצלחה                 |
| רענון אפליקציה בזמן מילוי     | חזרה לשאלה + מודאל בחירה     | נשען על `questionnaire_draft`      |
| רענון אחרי סיום ולפני הרשמה   | הנתונים קיימים → המשך ברישום | נטען `smart_questionnaire_results` |
| שינוי גרסה (version mismatch) | מבנה תשובות ישן              | טרנספורמציה (TODO עתידי)           |

## 🛡️ הערות אבטחה / פרטיות

- אין שליחת נתונים לשרת לפני סיום (למניעת זבל חלקי).
- JSON מקומי בלבד עד רישום.
- אפשר להוסיף הצפנה מקומית (Roadmap).

## 🚀 הרחבות עתידיות (Roadmap קצר)

- תמיכה ב-"עריכת שאלון" אחרי רישום תחת gating (Premium).
- זיהוי זניחת שאלון ושליחת תזכורת (Notifications).
- טרנספורמציית גרסאות תשובות (migration pipeline).

---

_נספח אינבריינטים ולוגים נוסף: 4 בספטמבר 2025_
